# 🔍 问题排查指南

## ⚠️ 如果还是调用失败，请按以下步骤排查

---

## 📋 排查步骤

### 1️⃣ 检查环境变量是否已配置

**在 Vercel Dashboard 中：**
1. 进入项目 → **Settings** → **Environment Variables**
2. 确认能看到 `OPENROUTER_API_KEY` 这一行
3. 确认三个环境都已勾选：✅ Production ✅ Preview ✅ Development

### 2️⃣ 使用调试端点检查配置

访问调试端点查看环境变量状态：
```
https://ai-tool-zeta.vercel.app/api/debug
```

**应该看到：**
```json
{
  "apiKey": {
    "configured": true,
    "length": 73,
    "preview": "sk-or-v1-f...081d2"
  }
}
```

**如果看到 `"configured": false`，说明环境变量未正确配置。**

### 3️⃣ 确认已重新部署

**重要：配置环境变量后必须重新部署！**

1. 在 Vercel Dashboard → **Deployments**
2. 找到最新的部署记录
3. 点击右侧 **"..."** → **Redeploy**
4. 等待部署完成（约1-2分钟）

### 4️⃣ 检查部署日志

1. 在 Vercel Dashboard → **Deployments**
2. 点击最新的部署记录
3. 查看 **Logs**（日志）
4. 查找是否有错误信息

**常见错误：**
- `OPENROUTER_API_KEY is not defined` - 环境变量未配置
- `401 Unauthorized` - API Key 无效
- `429 Too Many Requests` - API 调用频率限制

### 5️⃣ 验证 API Key 是否有效

**手动测试 API Key：**

```bash
curl https://openrouter.ai/api/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 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" \
  -d '{
    "model": "anthropic/claude-3.5-sonnet",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

**如果返回 401，说明 API Key 无效。**

---

## 🔧 常见问题及解决方案

### Q1: 环境变量已配置，但还是报错"未配置"

**可能原因：**
- ❌ 没有重新部署
- ❌ 环境变量名称拼写错误（区分大小写）
- ❌ 只配置了部分环境（Production/Preview/Development）

**解决方案：**
1. 确认变量名完全一致：`OPENROUTER_API_KEY`
2. 确认三个环境都勾选
3. 重新部署项目

### Q2: 调试端点显示 `configured: false`

**解决方案：**
1. 检查 Vercel Dashboard 中的环境变量配置
2. 确认变量名：`OPENROUTER_API_KEY`（全大写，下划线）
3. 确认值：`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`
4. 重新部署

### Q3: API 返回 401 错误

**可能原因：**
- API Key 无效或已过期
- API Key 格式错误（有多余空格）

**解决方案：**
1. 检查 API Key 是否有前后空格
2. 在 OpenRouter 网站验证 API Key 是否有效
3. 重新生成 API Key 并更新配置

### Q4: API 返回 429 错误（频率限制）

**解决方案：**
- 等待一段时间后重试
- 检查 OpenRouter 账户的调用限制
- 考虑升级 OpenRouter 套餐

### Q5: 部署后还是旧版本

**解决方案：**
1. 清除浏览器缓存
2. 强制刷新（Ctrl+F5 或 Cmd+Shift+R）
3. 检查 Vercel 部署是否完成（状态应该是 Ready）

---

## 🛠️ 快速修复步骤

如果以上都检查过了还是不行，按这个顺序操作：

1. **删除并重新添加环境变量**
   - Vercel Dashboard → Settings → Environment Variables
   - 删除 `OPENROUTER_API_KEY`
   - 重新添加（确保没有多余空格）
   - 三个环境全部勾选

2. **强制重新部署**
   - Deployments → 最新部署 → "..." → Redeploy
   - 等待完成

3. **清除缓存并测试**
   - 访问 `/api/debug` 检查配置
   - 访问应用测试功能

4. **查看日志**
   - Deployments → 最新部署 → Logs
   - 查找错误信息

---

## 📞 需要更多帮助？

如果以上步骤都无法解决问题，请提供：
1. `/api/debug` 端点的返回结果
2. Vercel 部署日志中的错误信息
3. 浏览器控制台（F12）的错误信息

---

**最新修复：代码已更新为运行时读取环境变量，确保能正确获取配置。**
